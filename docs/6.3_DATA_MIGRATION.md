## 6.3 Data migration

Dokumen ini menyajikan temuan faktual mengenai kebutuhan dan mekanisme migrasi data yang terlihat di repositori. Semua pernyataan diambil langsung dari skrip dan modul yang ada di kode sumber.

Ringkasan singkat
- Pernyataan penting: Sistem saat ini tidak memerlukan proses migrasi dari aplikasi atau basis data sebelumnya untuk dapat berfungsi. Semua dataset dan konfigurasi dapat diinisialisasi langsung melalui mekanisme konfigurasi/fitur yang tersedia pada sistem sekarang dan disimpan secara lokal di database SQLite (`data/app.db`).

- Catatan mengenai artefak migrasi yang ada: repositori masih menyimpan beberapa skrip migrasi di folder `archive/`. Skrip‑skrip ini bersifat alat bantu/manual untuk kasus impor data legacy (jika tim ingin memindahkan data dari format lama), tetapi tidak menjadi prasyarat untuk instalasi atau operasi standar sistem.

-- Ada dua artefak migrasi yang jelas di dalam repositori (arsip/manual):
  1. Skrip migrasi koneksi database (MySQL → "universal" plugin) yang berkomunikasi melalui API backend (`archive/migrate-connections.js`).
  2. Skrip migrasi status WhatsApp dari berkas JSON lokal ke tabel SQLite (`archive/migrate-whatsapp-status.js`).

Apakah perangkat lunak memerlukan migrasi data?
- Secara default: tidak. Sistem dapat diinstal dan dijalankan tanpa melakukan migrasi data dari aplikasi/DB sebelumnya. Semua dataset dan konfigurasi dapat dibuat melalui antarmuka/fitur sistem dan kemudian akan disimpan di database SQLite lokal.
- Kapan arsip migrasi relevan: skrip di `archive/` hanya diperlukan bila operator memiliki data legacy (mis. file JSON lama atau entri koneksi pada plugin lama) yang ingin diimpor ke struktur data saat ini. Dalam kasus tersebut, skrip migrasi dapat digunakan sebagai alat bantu manual untuk melakukan impor.

Kapan migrasi dijalankan dan prasyaratnya
- Skrip migrasi koneksi (`archive/migrate-connections.js`) beroperasi sebagai klien HTTP terhadap API backend. Skrip tersebut mengakses endpoint seperti `/database/migration/status`, `/database/migrate`, `/database/migrate/single`, dan `/database/test` pada `BASE_URL` yang dikonfigurasi (contoh: `http://localhost:8001/api` dalam skrip). Oleh karena itu, untuk menjalankan skrip ini backend harus berjalan dan dapat diakses pada alamat yang sesuai. Skrip juga menggunakan header `x-api-key` (satu nilai hardcoded terlihat dalam skrip contoh), sehingga akses API yang diperlukan harus disediakan.
- Skrip migrasi WhatsApp (`archive/migrate-whatsapp-status.js`) membaca berkas JSON dari jalur relatif `wa/.status/whatsapp-status.json`. Skrip memeriksa apakah entri status sudah ada di database (menggunakan prepared statement `getWhatsAppStatus`) dan hanya akan memasukkan data jika belum ada. Untuk menjalankannya, diperlukan Node.js di lingkungan kerja dan akses baca ke berkas JSON serta akses tulis ke database SQLite.

Di mana data akan tersedia setelah migrasi
- Koneksi yang berhasil dimigrasi menjadi entri pada backend; proses migrasi berkomunikasi melalui API backend sehingga hasil migrasi terlihat sebagai data sumber daya yang dikelola oleh layanan backend (endpoint `GET /data-sources` dan endpoint terkait pada API). Lokasi fisik penyimpanan koneksi akhir bergantung pada implementasi backend (dalam repositori ini, konfigurasi data sumber tersimpan di tabel `data_sources` pada SQLite — lihat `avevapi/lib/database.js`).
- Status WhatsApp dimigrasikan ke tabel `whatsapp_status` pada database SQLite. Lokasi file database yang dipakai oleh backend adalah `data/app.db` (ditentukan oleh `avevapi/lib/database.js`, relatif terhadap direktori kerja proses). Tabel `whatsapp_status` memiliki skema dengan kolom seperti `is_ready`, `bot_number`, `phone_number`, `last_update`, dan lain‑lain.

Bagaimana migrasi dijalankan (efek teknis yang terlihat)
- Koneksi: skrip `migrate-connections.js` menjalankan langkah pemeriksaan status, dry-run migrasi melalui `POST /database/migrate` dengan payload `{ dryRun: true }`, menampilkan hasil dry-run, lalu memanggil endpoint migrasi individual (`/database/migrate/single`) untuk masing‑masing koneksi yang siap. Skrip tersebut juga memanggil endpoint pengujian koneksi (`/database/test`) untuk memvalidasi koneksi setelah migrasi.
- WhatsApp status: skrip `migrate-whatsapp-status.js` membaca JSON, memetakan field JSON ke kolom tabel, dan menjalankan pernyataan ter-preparasi `insertWhatsAppStatus` untuk menyimpan atau menggantikan baris status (skrip memakai `INSERT OR REPLACE` melalui prepared statement yang ada di modul database).

Catatan bukti (referensi berkas yang diperiksa)
- `archive/migrate-connections.js`
- `archive/migrate-whatsapp-status.js`
- `avevapi/lib/database.js` (menunjukkan lokasi database `data/app.db`, skema tabel `whatsapp_status`, dan prepared statements `getWhatsAppStatus` / `insertWhatsAppStatus`)

Pernyataan penutup
- Temuan di atas adalah pernyataan faktual yang diekstrak dari skrip migrasi dan modul database pada repositori. Dokumen ini tidak memuat rekomendasi atau langkah tindakan yang bersifat opsional; hanya menjelaskan kebutuhan/ketentuan migrasi yang terlihat di kode.

Instruksi singkat: menjalankan skrip migrasi (opsional)
- Catatan penting: bagian ini hanya berisi langkah operasional singkat untuk menjalankan skrip migrasi yang ada di folder `archive/`. Menjalankan migrasi dapat mengubah data pada database; jalankan hanya jika Anda paham risikonya.

- Prasyarat umum:
  - Node.js terpasang pada mesin yang menjalankan skrip (versi modern yang kompatibel dengan dependensi proyek).
  - Backend (`avevapi`) berjalan dan dapat diakses jika menjalankan `archive/migrate-connections.js` (skrip ini memanggil API HTTP lokal). Pastikan alamat `BASE_URL` di dalam skrip sesuai (contoh `http://localhost:8001/api`).
  - Akses baca ke `wa/.status/whatsapp-status.json` jika menjalankan `archive/migrate-whatsapp-status.js`.
  - Akses tulis ke folder `data/` agar `avevapi` dapat menyimpan `data/app.db` (database SQLite).

- Menjalankan migrasi status WhatsApp (file → database)
  1. Buka command prompt (cmd.exe) pada root proyek.
  2. Pastikan dependensi terinstal pada environment yang sesuai untuk menjalankan skrip (mis. `node` tersedia).
  3. Jalankan perintah berikut:

    cd g:\NExtJS\aveva-pi
    node archive/migrate-whatsapp-status.js

  4. Skrip akan melaporkan apakah file JSON ditemukan, memeriksa kemunculan entri `whatsapp_status` di database, dan melakukan `INSERT OR REPLACE` bila perlu.

- Menjalankan migrasi koneksi (via API backend)
  1. Pastikan backend `avevapi` berjalan dan endpoint API bisa diakses pada `BASE_URL` yang dikonfigurasi di `archive/migrate-connections.js`.
  2. Di command prompt pada root proyek, jalankan:

    cd g:\NExtJS\aveva-pi
    node archive/migrate-connections.js

  3. Skrip melakukan pemeriksaan status, dry-run (`dryRun: true`), menampilkan hasil, dan jika siap akan melakukan migrasi per‑koneksi dengan memanggil endpoint `/database/migrate/single` untuk setiap koneksi.

- Troubleshooting singkat:
  - Jika skrip `migrate-connections.js` mengembalikan error koneksi, periksa bahwa backend berjalan dan `BASE_URL` serta header `x-api-key` benar.
  - Jika `migrate-whatsapp-status.js` tidak menemukan file JSON, cek adanya file `wa/.status/whatsapp-status.json` dan hak akses baca.
  - Periksa `data/app.db` setelah migrasi untuk memastikan tabel `whatsapp_status` berisi baris yang diharapkan.


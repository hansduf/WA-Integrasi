Integration with External Systems

The system integrates with several external data sources and APIs to support its functionality:

Integration with External Systems

Dokumen ini melengkapi daftar integrasi eksternal dengan referensi file (dari `avevapi/plugins` dan `avevapi/services`), mekanisme komunikasi, konfigurasi/autentikasi, risiko, dan rekomendasi tindakan cepat.

1) AVEVA PI — Sistem telemetry dan historian
- Penjelasan: Digunakan untuk mengambil data real-time/historis untuk monitoring dan visualisasi.
- File touchpoints: `plugins/aveva-pi/index.js`, `avevapi/routes/pi_routes.js`, `frontend/.../AvevaPITriggerForm.tsx`, `wa/index.js` (memanggil `/pi/ask`, `/pi/upload`).
- Metode komunikasi: REST API (proxy melalui backend `pi_routes.js`), bot memanggil backend yang kemudian memanggil PI.
- Konfigurasi/auth: koneksi PI disimpan di `data_sources` (lihat `avevapi/lib/database.js` schema). Kredensial harus disimpan di server, bukan frontend.
- Risiko: ekspos kredensial, query terlalu berat (time & size), akses langsung dari frontend.
- Rekomendasi cepat: proxy semua panggilan PI lewat backend, batasi ukuran hasil, logging & rate-limiting pada route PI.

2) Oracle Database — sumber data operasional
- Penjelasan: Koneksi langsung menggunakan driver `oracledb` untuk query yang tidak tersedia di PI.
- File touchpoints: `plugins/database/drivers/oracle.js`, `plugins/database/dialects/oracle.js`, `avevapi/lib/database.js` (data_sources schema), `archive/test-oracle-api.js`.
- Metode komunikasi: koneksi DB langsung dari backend (driver server-side).
- - Konfigurasi/auth: Hanya sebagai sumber data (tidak untuk penyimpanan lokal). Konfigurasi connection string dan credential TERSIMPAN HANYA di SQLite lokal (`data/app.db`) pada tabel `data_sources` (lihat `avevapi/lib/database.js`). Pastikan kredensial tidak disimpan secara plain-text di repo.
- Risiko: credential leaking, long-running queries, resource exhaustion.
- Rekomendasi cepat: validasi/escape input, set query timeouts, simpan creds di secrets store, tambahkan connection pooling dan circuit breakers.

3) MySQL — integrasi dataset tambahan & migrasi
- Penjelasan: Sumber data tambahan; ada skrip migrasi untuk porting koneksi MySQL ke plugin universal.
- File touchpoints: `plugins/database/drivers  /mysql.js`, `plugins/database/dialects/mysql.js`, `archive/migrate-connections.js`, `avevapi/routes/data-sources.js`.
- Metode komunikasi: koneksi DB server-side untuk query; migrasi via HTTP API (`/database/migrate`) oleh skrip di `archive/`.
- - Konfigurasi/auth: Hanya sebagai sumber data (tidak untuk penyimpanan lokal). Konfigurasi connection string dan credential TERSIMPAN HANYA di SQLite lokal (`data/app.db`) pada tabel `data_sources`. Skrip arsip (`archive/`) hanya berisi contoh dan kadang mengandung `BASE_URL`/API key contoh yang harus diremove/redact sebelum digunakan.
- Risiko: archived scripts contain hardcoded keys/URLs, unvalidated migration data, accidental public exposure.
- Rekomendasi cepat: redact keys from `archive/` scripts, require env vars for BASE_URL and API_KEY, add migration dry-run summaries and manual approval step.

4) WhatsApp Web Service — `whatsapp-web.js` + Puppeteer (bot)
- Penjelasan: Bot WhatsApp berinteraksi melalui whatsapp-web.js menjalankan headless Chromium (Puppeteer) untuk mengirim/terima pesan.
- File touchpoints: `wa/index.js`, `wa/package.json`, status/session paths `wa/.status/whatsapp-status.json` dan `wa/sessions` (LocalAuth), DB prepared-statements (`getWhatsAppStatus`, `insertWhatsAppStatus`) di `avevapi/lib/database.js`.
- Metode komunikasi: WebSocket/Browser automation (whatsapp-web.js) untuk WhatsApp; HTTP (axios) antara bot <-> backend (menggunakan header `x-api-key`).
- Konfigurasi/auth: session persistence dengan `LocalAuth`; bot menggunakan `process.env.API_KEY` (perlu dipastikan tidak fallback ke literal).
- Risiko: session file leaking, hardcoded API key fallback, headless browser resource/capacity, QR data exposure.
- Rekomendasi cepat: gitignore session/status dirs, set filesystem permissions, hapus fallback literal API key, centralize bot HTTP client with timeout & retries, monitor Puppeteer memory/CPU.

5) AI API Endpoint — internal AI trigger & chat
- Penjelasan: Endpoint AI dipakai untuk trigger berbasis NLP dan chat; bot meminta triggers dan mengirim prompt ke `/api/ai/*`.
- File touchpoints: `plugins/ai/ai-service.js`, `wa/index.js` (panggil `/api/ai/triggers`, `/api/ai/chat`), backend AI routes under `avevapi/routes/*` (AI related files).
- Metode komunikasi: REST API, bot => backend => AI provider (internal/external) tergantung konfigurasi plugin.
- Konfigurasi/auth: menggunakan API key untuk backend; AI provider credentials ada di konfigurasi plugin/secret store.
- Risiko: cost dari panggilan AI, prompt injection, large responses, unmetered requests.
- Rekomendasi cepat: rate-limit AI endpoints, add per-key quotas, sanitize inputs, bounding response sizes, and monitor usage/cost.

6) Backend API (Express) — pusat integrasi
- Penjelasan: `avevapi` bertindak sebagai proxy dan orkestrator; menangani auth, routing, data_sources, dan expose endpoints untuk frontend & bot.
- File touchpoints: `avevapi/routes/*`, `avevapi/lib/database.js`, `avevapi/config/index.js`, `avevapi/services/*.js` (auth.service.js, security.service.js, user.service.js).
- Metode komunikasi: internal function calls + HTTP (axios) untuk external integrations.
- Konfigurasi/auth: dual-auth middleware, `x-api-key` checks, JWT untuk user sessions (lihat `services/auth.service.js`).
- Risiko: inconsistent auth exposure (frontend using NEXT_PUBLIC_*), hardcoded keys in configs/docs.
- Rekomendasi cepat: centralize auth checks, deprecate NEXT_PUBLIC admin keys, enforce env-only secrets for server.

7) Local SQLite — penyimpanan utama
- - Penjelasan: `better-sqlite3` pada `data/app.db` menyimpan tabel kritikal (`whatsapp_status`, `ai_triggers`, `data_sources`, dsb.). Semua konfigurasi koneksi untuk sumber eksternal (AVEVA PI, Oracle, MySQL, dsb.) disimpan PUSAT di sini (tabel `data_sources`).
- - File touchpoints: `avevapi/lib/database.js` (schema & prepared statements).
- Risiko: file-based DB concurrency, backup/restore strategy.
- Rekomendasi cepat: schedule backups, monitor WAL size, document restore steps.

Isu sensitif yang ditemukan (harus ditindaklanjuti):
- Literal API key `universal-api-key-2025` terdapat di beberapa file (contoh di `wa/index.js`, `avevapi/config/index.js`, `archive/*.js`, frontend examples). Harus diganti dan di-rotate segera.
- Archive scripts (`archive/*.js`) mengandung `BASE_URL`/API key contoh — beri peringatan header dan hapus literal.

Langkah tindakan segera (3 item paling prioritas):
1. Hapus fallback literal API key: ubah kode agar hanya membaca `process.env.API_KEY` dan gagal jika tidak ada (production). (Saya bisa patch ini jika kamu setuju.)
2. Tambahkan `.gitignore`/CI secret-scan untuk menolak commits yang mengandung API keys.
3. Redact `archive/` scripts dan tambahkan header README "SCRIPTS ARE ONE-OFF; REVIEW BEFORE RUNNING".

Jika setuju, langkah berikut yang bisa saya lakukan sekarang (pilih salah satu):
- Patch literal API key di `wa/index.js` dan `avevapi/config/index.js` (ganti fallback dengan env-only) + jalankan grep verifikasi.
- Tambahkan header peringatan dan ganti literal API key di `archive/migrate-connections.js` dengan placeholder `process.env.MIGRATE_API_KEY`.
- Buat `avevapi/lib/http-client.js` (axios wrapper) dan contoh kecil penggunaan di satu route.

Selesai: file ini sekarang telah diperluas menggunakan struktur `plugins/` dan `services/` yang kamu berikan. Beritahu saya langkah mana yang mau saya jalankan sekarang.


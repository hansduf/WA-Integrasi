version: '3.8'

services:
  # Backend API Service
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: aveva-backend
    ports:
      - "0.0.0.0:8002:8002"
    environment:
      - NODE_ENV=production
      - PORT=8002
      - HOST=0.0.0.0
      - HTTPS=false  # Set to 'true' for HTTPS/production deployment
      # Admin user
      - ADMIN_USERNAME=admin
      - ADMIN_PASSWORD=CHANGE_ME_NOW!
      # API Keys
      - API_KEY=universal-api-key-2025
      - TRIGGERS_ADMIN_KEY=universal-api-key-2025
      - ALLOW_NGROK_COOKIES=true
      # CORS - Allow frontend to access backend (REQUIRED - set your network IP)
      - CORS_ORIGINS=http://192.168.137.221:3002
    volumes:
      - ./avevapi/data:/app/avevapi/data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://0.0.0.0:8002/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Frontend Service
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        - NEXT_PUBLIC_BACKEND_URL=http://192.168.137.221:8002
    container_name: aveva-frontend
    ports:
      - "0.0.0.0:3002:3002"
    environment:
      - NODE_ENV=production
      - PORT=3002
      # Backend URL untuk external clients (gunakan IP local lokal, bukan public IP)
      - NEXT_PUBLIC_BACKEND_URL=http://192.168.137.221:8002
      - NEXT_PUBLIC_API_KEY=universal-api-key-2025
      - NEXT_PUBLIC_TRIGGERS_ADMIN_KEY=universal-api-key-2025
    networks:
      - app-network
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped

  # WhatsApp Bot Service
  wa-bot:
    build:
      context: .
      dockerfile: Dockerfile.wa
    container_name: aveva-wa-bot
    environment:
      - NODE_ENV=production
      # Internal backend communication (via docker network)
      - BACKEND_HOST=backend
      - BACKEND_PORT=8002
      - API_BASE_URL=http://backend:8002
      - API_KEY=universal-api-key-2025
      - TRIGGERS_ADMIN_KEY=universal-api-key-2025
    volumes:
      - ./wa/sessions:/app/wa/sessions
    networks:
      - app-network
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped

networks:
  app-network:
    driver: bridge

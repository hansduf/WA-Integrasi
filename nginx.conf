# Nginx Configuration untuk AVEVA PI
# 
# INSTALLATION:
# 1. Copy file ini ke: /etc/nginx/sites-available/aveva-pi
# 2. Enable dengan: sudo ln -s /etc/nginx/sites-available/aveva-pi /etc/nginx/sites-enabled/
# 3. Test: sudo nginx -t
# 4. Reload: sudo systemctl reload nginx
#
# SSL SETUP:
# sudo certbot certonly --nginx -d your-domain.com -d www.your-domain.com
#
# NOTES:
# - Replace 'your-domain.com' dengan domain Anda
# - Pastikan backend running di port 8001
# - Pastikan frontend running di port 3000

# ==========================================
# Upstream Configuration
# ==========================================

upstream backend {
    server localhost:8001;
    keepalive 64;
}

upstream frontend {
    server localhost:3000;
    keepalive 64;
}

# ==========================================
# HTTP to HTTPS Redirect
# ==========================================

server {
    listen 80;
    listen [::]:80;
    server_name your-domain.com www.your-domain.com;
    
    # Redirect all HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

# ==========================================
# HTTPS Server Block (Production)
# ==========================================

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name your-domain.com www.your-domain.com;

    # ==========================================
    # SSL Certificates (Let's Encrypt)
    # ==========================================
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # ==========================================
    # SSL Configuration
    # ==========================================
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;
    
    # OCSP stapling
    ssl_stapling on;
    ssl_stapling_verify on;

    # ==========================================
    # Security Headers
    # ==========================================
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # ==========================================
    # Logging
    # ==========================================
    access_log /var/log/nginx/aveva-pi-access.log combined buffer=32k flush=5s;
    error_log /var/log/nginx/aveva-pi-error.log warn;

    # ==========================================
    # Gzip Compression
    # ==========================================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/atom+xml image/svg+xml;
    gzip_disable "msie6";

    # ==========================================
    # Client Upload Size
    # ==========================================
    client_max_body_size 50M;

    # ==========================================
    # Timeouts
    # ==========================================
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # ==========================================
    # Frontend - Root (/)
    # ==========================================
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        
        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
        
        # Cache bypass
        proxy_cache_bypass $http_upgrade;
    }

    # ==========================================
    # Backend API (/api/*)
    # ==========================================
    location /api/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        
        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts for API calls
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # Buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        
        # Cache bypass
        proxy_cache_bypass $http_upgrade;
    }

    # ==========================================
    # PI Routes (/pi/*)
    # ==========================================
    location /pi/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # ==========================================
    # WhatsApp Routes (/whatsapp/*)
    # ==========================================
    location /whatsapp/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # ==========================================
    # Health Check (/health)
    # ==========================================
    location = /health {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        access_log off;
    }

    # ==========================================
    # Static Files Caching
    # ==========================================
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        # Long-term caching for immutable assets
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # ==========================================
    # Deny Access to Sensitive Files
    # ==========================================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ==========================================
    # Deny Access to node_modules
    # ==========================================
    location ~ /node_modules/ {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ==========================================
# IPv6 Redirect (optional)
# ==========================================
# Uncomment if you want to handle IPv6 separately
# server {
#     listen [::]:80;
#     server_name your-domain.com www.your-domain.com;
#     return 301 https://$server_name$request_uri;
# }

###############################################
# SETUP INSTRUCTIONS
###############################################

# 1. Copy this file to Nginx sites-available
# sudo cp nginx.conf /etc/nginx/sites-available/aveva-pi

# 2. Create symlink to sites-enabled
# sudo ln -s /etc/nginx/sites-available/aveva-pi /etc/nginx/sites-enabled/

# 3. Test Nginx configuration
# sudo nginx -t

# 4. Reload Nginx
# sudo systemctl reload nginx

# 5. Setup SSL Certificate (if not already done)
# sudo certbot certonly --nginx -d your-domain.com -d www.your-domain.com

# 6. Verify SSL
# sudo certbot certificates

# 7. Enable auto-renewal
# sudo systemctl enable certbot.timer
# sudo systemctl start certbot.timer

# 8. Test renewal
# sudo certbot renew --dry-run

###############################################
# MONITORING
###############################################

# View access logs
# tail -f /var/log/nginx/aveva-pi-access.log

# View error logs
# tail -f /var/log/nginx/aveva-pi-error.log

# Check Nginx status
# sudo systemctl status nginx

# Restart Nginx
# sudo systemctl restart nginx

# Reload Nginx (graceful)
# sudo systemctl reload nginx

# Test config
# sudo nginx -t

###############################################
# TROUBLESHOOTING
###############################################

# 502 Bad Gateway
# - Check if backend is running: pm2 list
# - Check backend logs: pm2 logs aveva-backend

# 503 Service Unavailable
# - Check frontend: pm2 list
# - Check frontend logs: pm2 logs aveva-frontend

# SSL Certificate Error
# - Renew certificate: sudo certbot renew
# - Check cert status: sudo certbot certificates

# Connection Refused
# - Check port 8001: sudo lsof -i :8001
# - Check port 3000: sudo lsof -i :3000

# Performance Issues
# - Monitor backend: pm2 monit
# - Check Nginx: sudo systemctl status nginx
# - Check disk space: df -h
# - Check memory: free -h
